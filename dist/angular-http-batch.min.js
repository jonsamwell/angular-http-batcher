/*
 * angular-http-batcher - v1.12.0 - 2016-02-16
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2016 Jon Samwell;*/
!function(a){"use strict";function b(){var b=[],c="httpBatchAdapter",d={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"],sendCookies:!1,enabled:!0,adapter:c,uniqueRequestName:null};this.setAllowedBatchEndpoint=function(e,f,g){var h=a.copy(d);void 0!==g&&(a.forEach(g,function(a,b){h[b]=a}),a.forEach(h.ignoredVerbs,function(a,b){h.ignoredVerbs[b]=a.toLowerCase()})),h.serviceUrl=e,h.batchEndpointUrl=f,h.adapter=h.adapter||c,b.push(h)},this.getBatchConfig=function(a){var c,d;for(d=0;d<b.length&&(c=b[d],!(a.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a),d=c?c.canBatchRequest:void 0,e=!1;return c&&c.enabled===!0&&(e=d?d(a,b):c.batchEndpointUrl!==a&&-1===a.indexOf(c.batchEndpointUrl)&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())),e},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}function c(a,b,c,d,e){this.request=a,this.statusCode=b,this.statusText=c,this.data=d,this.headers=e}function d(b,c,d){function e(a,c){var e,f,g,h,j,k,l=d.calculateBoundary(),m={method:"POST",url:c.batchEndpointUrl,cache:!1,headers:c.batchRequestHeaders||{}},n=[];for(m.headers[p.contentType]="multipart/mixed; boundary="+l,f=0;f<a.length;f+=1){if(g=a[f],e=i(g.url),n.push(p.doubleDash+l),c.batchPartRequestHeaders)for(h in c.batchPartRequestHeaders)if(c.batchPartRequestHeaders.hasOwnProperty(h)){var o=h+p.colon+p.singleSpace+c.batchPartRequestHeaders[h];"content-disposition"===h.toLowerCase()&&null!==c.uniqueRequestName&&void 0!==c.uniqueRequestName&&(o+=p.semiColon+p.singleSpace+p.requestName+c.uniqueRequestName+f),n.push(o)}n.push("Content-Type: application/http; msgtype=request",p.emptyString),j=e.relativeUrl.split("?"),k=j.length>1&&/%[A-F0-9]{2}/gi.test(j[1])===!1?encodeURI(e.relativeUrl):encodeURI(j[0])+(j.length>1?"?"+j[1]:""),n.push(g.method+" "+k+" "+p.httpVersion),n.push("Host: "+e.host);for(h in g.headers)n.push(h+p.colon+p.singleSpace+g.headers[h]);c.sendCookies===!0&&b[0].cookie&&b[0].cookie.length>0&&n.push("Cookie: "+b[0].cookie),n.push(p.emptyString),g.data&&n.push(g.data),n.push(p.emptyString)}return n.push(p.doubleDash+l+p.doubleDash),m.data=n.join(p.newline),m}function f(a,b,c){var d,e,f=[],g=j(b.headers()["content-type"]),h=b.data.split(p.doubleDash+g+p.newline),i=0;for(d=0;d<h.length;d+=1)e=h[d],e!==p.emptyString&&(f.push(m(e,a[i],g)),i+=1);return f}function g(a,b){return!0}function h(a){return a=a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")}function i(a){var b,d,e,f,g;if(a.indexOf("./")>-1||a.indexOf("../")>-1){var h=document.createElement("a");h.href=a,a=h.href}return a.indexOf("://")>-1?(f=a.indexOf("://")+3,g=a.slice(f).split(p.forwardSlash),b=a.substring(0,f),d=g[0],e=function(){return delete g[0],g.join(p.forwardSlash)}()):(e=a,b=c.location.protocol,d=c.location.host),{protocol:b,host:d,relativeUrl:e}}function j(a){var b="boundary=",c=a.indexOf(b),d=a.indexOf(";",c),e=a.substring(c+b.length,d>0?d:a.length);return e=e.replace(/"/g,p.emptyString)}function k(a){return"string"==typeof a?a.replace(")]}',\n",""):a}function l(b,c){var d=c;return b=b.toLowerCase(),b.indexOf("json")>-1&&(c=k(c),d=a.fromJson(c)),d}function m(a,b,c){var d,e,f,g,i,j,k=a.split(p.newline),m={headers:{}},n=!1;for(e=0;e<k.length;e+=1)if(d=k[e],d!==p.emptyString){if(void 0===m.contentType&&-1!==d.indexOf("-Type")&&-1===d.indexOf("; msgtype=response"))m.contentType=d.split(p.forwardSlash)[1];else if(void 0!==m.contentType&&n===!1)j=d.split(p.colon),m.headers[j[0]]=h(j[1]);else if(void 0===m.statusCode&&-1!==d.indexOf(p.httpVersion))i=d.split(p.singleSpace),m.statusCode=parseInt(i[1],10),m.statusText=i.slice(2).join(p.singleSpace);else if(void 0===m.data&&n){for(m.data="",f=1,g=new RegExp("--"+c+"--","i");g.test(d)===!1&&e+f<=k.length;)m.data+=d,d=k[e+f],f+=1;m.data=l(m.contentType,m.data);break}}else n=void 0!==m.contentType;return m.headers[p.contentType]=m.contentType,new o.ahb.HttpBatchResponseData(b,m.statusCode,m.statusText,m.data,m.headers)}var n=this,p={httpVersion:"HTTP/1.1",contentType:"Content-Type",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":",semiColon:";",requestName:"name="};n.key="httpBatchAdapter",n.buildRequest=e,n.parseResponse=f,n.canBatchRequest=g}function e(){function a(a,b){var c,d,e,f,g={method:"GET",url:b.batchEndpointUrl+"?",cache:!1,headers:b.batchRequestHeaders||{}};for(d=0;d<a.length;d+=1)e=a[d],f=e.url.split("?"),c=f[0].replace(b.serviceUrl,""),f.length>1&&(c+="?"+encodeURIComponent(f[1])),d>0&&(g.url+="&"),g.url+=d.toString()+"="+c;return g}function b(a,b){var c,d,e,f=[],g=b.data;for(c=0;c<a.length;c+=1)d=a[c],e=g[c.toString()],f.push(new o.ahb.HttpBatchResponseData(d,e.statusCode,"",e.body,e.headers));return f}function c(a){return"GET"===a.method}var d=this;d.key="nodeJsMultiFetchAdapter",d.buildRequest=a,d.parseResponse=b,d.canBatchRequest=c}function f(a){var b,c="";for(b in a)c+=b+": "+a[b]+"\n";return c}function g(){var a=this.config.adapter;if("object"==typeof a){if(void 0===a.buildRequest||void 0===a.parseResponse)throw new Error('A custom adapter must contain the methods "buildRequest" and "parseResponse" - please see the docs')}else if("string"==typeof a&&(a=this.adapters[a],void 0===a))throw new Error("Unknown type of http batch adapter: "+this.config.adapter);return a}function h(a){return this.requests.push(a),this.requests.length>=this.config.maxBatchedRequestPerCall&&this.flush(),!0}function i(){var b=this,c=b.getAdapter(),d=c.buildRequest(b.requests,b.config);b.sendCallback(),b.$injector.get("$http")(d).then(function(d){var e=c.parseResponse(b.requests,d,b.config);a.forEach(e,function(a){a.request.callback(a.statusCode,a.data,f(a.headers),a.statusText)})},function(c){a.forEach(b.requests,function(a){a.callback(c.statusCode,c.data,c.headers,c.statusText)})})}function j(){this.$timeout.cancel(this.currentTimeoutToken),this.currentTimeoutToken=void 0,this.send()}function k(b,c,d,e,f){var g=this;this.$injector=b,this.$timeout=c,this.adapters=d,this.config=e,this.sendCallback=f,this.requests=[],this.currentTimeoutToken=c(function(){g.currentTimeoutToken=void 0,g.requests.length<g.config.minimumBatchSize?(g.sendCallback(),a.forEach(g.requests,function(a){a.continueDownNormalPipeline()})):g.send(b)},e.batchRequestCollectionDelay,!1)}function l(b,c,d,e,f){function g(a,b){return d.canBatchCall(a,b)}function h(a){var e=d.getBatchConfig(a.url),f=l[e.batchEndpointUrl];void 0===f&&(f=new k(b,c,m,e,function(){delete l[e.batchEndpointUrl]}),l[e.batchEndpointUrl]=f),f.addRequest(a)}function i(b){a.forEach(l,function(a,c){var d=void 0===b||b&&c.toLocaleLowerCase()===b.toLocaleLowerCase();d&&a.flush()})}var j=this,l={},m={httpBatchAdapter:e,nodeJsMultiFetchAdapter:f};j.canBatchRequest=g,j.batchRequest=h,j.flush=i}function m(b,c){var d=function(a,d,e,f,g,h,i,j){var k=this,l=arguments;return c.canBatchRequest(d,a)?void c.batchRequest({method:a,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j,continueDownNormalPipeline:function(){b.apply(k,l)}}):b.apply(this,arguments)};return a.mock&&a.forEach(b,function(a,b){d[b]=a}),d}function n(a){a.decorator("$httpBackend",m)}var o={ahb:{name:"jcs.angular-http-batch"}};a.module(o.ahb.name,[]),a.module(o.ahb.name).provider("httpBatchConfig",b),o.ahb.HttpBatchResponseData=c,d.$inject=["$document","$window","httpBatchConfig"],a.module(o.ahb.name).service("httpBatchAdapter",d),a.module(o.ahb.name).service("nodeJsMultiFetchAdapter",e),k.prototype.getAdapter=g,k.prototype.send=i,k.prototype.addRequest=h,k.prototype.flush=j,l.$inject=["$injector","$timeout","httpBatchConfig","httpBatchAdapter","nodeJsMultiFetchAdapter"],a.module(o.ahb.name).service("httpBatcher",l),m.$inject=["$delegate","httpBatcher"],n.$inject=["$provide"],a.module(o.ahb.name).config(n)}(angular);