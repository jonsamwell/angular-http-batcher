/*
 * angular-http-batcher - v1.6.0 - 2015-01-12
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2015 Jon Samwell;*/
!function(a,b){"use strict";a.ahb={name:"jcs.angular-http-batch"},b.module(a.ahb.name,[]),b.module(a.ahb.name).provider("httpBatchConfig",[function(){var a=[],c={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"]};this.setAllowedBatchEndpoint=function(d,e,f){var g=b.copy(c);void 0!==f&&(b.forEach(f,function(a,b){g[b]=a}),b.forEach(g.ignoredVerbs,function(a,b){g.ignoredVerbs[b]=a.toLowerCase()})),g.serviceUrl=d,g.batchEndpointUrl=e,a.push(g)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a);return void 0!==c&&c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),b.module(a.ahb.name).factory("httpBatcher",["$injector","$window","$timeout","httpBatchConfig",function(a,c,d,e){var f={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},g={},h=function(a,b){this.part=a,this.request=b},i=function(a,c){var e=this;this.config=a,this.sendCallback=c,this.requests=[],this.currentTimeoutToken=d(function(){e.currentTimeoutToken=void 0,e.requests.length<e.config.minimumBatchSize?(e.sendCallback(),b.forEach(e.requests,function(a){a.continueDownNormalPipeline()})):e.send()},a.batchRequestCollectionDelay,!1)},j=function(a,b){return e.canBatchCall(a,b)},k=function(a){var b=e.getBatchConfig(a.url),c=g[b.batchEndpointUrl];void 0===c&&(c=new i(b,function(){delete g[b.batchEndpointUrl]}),g[b.batchEndpointUrl]=c),c.addRequest(a)},l=function(a){b.forEach(g,function(b,c){var d=void 0===a||a&&c.toLocaleLowerCase()===a.toLocaleLowerCase();d&&b.flush()})};return h.prototype=function(){var a=function(a,c){var d=c;return a=a.toLowerCase(),a.indexOf("json")>-1&&(d=b.fromJson(c)),d},c=function(a){return a=a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},d=function(a){var b,c="";for(b in a)c+=b+": "+a[b]+"\n";return c},e=function(){var b,e,g,h,i,j,k=this.part.split(f.newline),l={headers:{}},m=!1;for(e=0;e<k.length;e+=1)if(b=k[e],b!==f.emptyString){if(void 0===l.contentType&&-1!==b.indexOf("-Type")&&-1===b.indexOf("; msgtype=response"))l.contentType=b.split(f.forwardSlash)[1];else if(void 0!==l.contentType&&m===!1)j=b.split(f.colon),l.headers[j[0]]=c(j[1]);else if(void 0===l.statusCode&&-1!==b.indexOf(f.httpVersion))i=b.split(f.singleSpace),l.statusCode=parseInt(i[1],10),l.statusText=i.slice(2).join(f.singleSpace);else if(void 0===l.data&&m){for(l.data="",g=1,h=new RegExp("--.*--","i");h.test(b)===!1&&e+g<=k.length;)l.data+=b,b=k[e+g],g+=1;l.data=a(l.contentType,l.data);break}}else m=void 0!==l.contentType;l.headers["Content-Type"]=l.contentType,l.headerString=d(l.headers),this.request.callback(l.statusCode,l.data,l.headerString,l.statusText)};return{process:e}}(),i.prototype=function(){var g=function(a,b){var c,d,g,h,i=e.calculateBoundary(),j={method:"POST",url:b.batchEndpointUrl,cache:!1,headers:{"Content-Type":"multipart/mixed; boundary="+i}},k=[];for(d=0;d<a.length;d+=1){g=a[d],c=l(g.url),k.push(f.doubleDash+i),k.push("Content-Type: application/http; msgtype=request",f.emptyString),k.push(g.method+" "+c.relativeUrl+" "+f.httpVersion),k.push("Host: "+c.host);for(h in g.headers)k.push(h+": "+g.headers[h]);k.push(f.emptyString),g.data&&k.push(g.data),k.push(f.emptyString)}return k.push(f.doubleDash+i+f.doubleDash),j.data=k.join(f.newline),j},i=function(){var c=this;this.sendCallback(),a.get("$http")(g(this.requests,this.config)).then(function(a){var b,d,e,g=m(a.headers()["content-type"]),i=a.data.split(f.doubleDash+g+f.newline),j=0;for(b=0;b<i.length;b+=1)d=i[b],d!==f.emptyString&&(e=new h(d,c.requests[j]),e.process(),j+=1)},function(a){b.forEach(c.requests,function(b){b.callback(a.statusCode,a.data,a.headers,a.statusText)})})},j=function(a){return this.requests.push(a),this.requests.length>this.config.maxBatchedRequestPerCall&&this.flush(),!0},k=function(){d.cancel(this.currentTimeoutToken),this.currentTimeoutToken=void 0,this.send()},l=function(a){var b,d,e,g,h;return a.indexOf("://")>-1?(g=a.indexOf("://")+3,h=a.slice(g).split(f.forwardSlash),b=a.substring(0,g),d=h[0],e=function(){return delete h[0],h.join(f.forwardSlash)}()):(e=a,b=c.location.protocol,d=c.location.host),{protocol:b,host:d,relativeUrl:e}},m=function(a){var b="boundary=",c=a.indexOf(b),d=a.substring(c+b.length);return d=d.replace(/"/g,f.emptyString)};return{addRequest:j,send:i,flush:k}}(),{canBatchRequest:j,batchRequest:k,flush:l}}]),b.module(a.ahb.name).config(["$provide",function(a){a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,c){var d=function(b,d,e,f,g,h,i,j){var k=this,l=arguments;return c.canBatchRequest(d,b)?void c.batchRequest({method:b,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j,continueDownNormalPipeline:function(){a.apply(k,l)}}):a.apply(this,arguments)};return b.mock&&b.forEach(a,function(a,b){d[b]=a}),d}])}])}(window,angular);