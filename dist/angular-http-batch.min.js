/*
 * angular-http-batcher - v1.9.0 - 2015-07-15
 * https://github.com/jonsamwell/angular-http-batcher
 * Copyright (c) 2015 Jon Samwell;*/
!function(a,b){"use strict";a.ahb={name:"jcs.angular-http-batch"},b.module(a.ahb.name,[]),b.module(a.ahb.name).provider("httpBatchConfig",[function(){var a=[],c={maxBatchedRequestPerCall:10,minimumBatchSize:2,batchRequestCollectionDelay:100,ignoredVerbs:["head"],sendCookies:!1,enabled:!0};this.setAllowedBatchEndpoint=function(d,e,f){var g=b.copy(c);void 0!==f&&(b.forEach(f,function(a,b){g[b]=a}),b.forEach(g.ignoredVerbs,function(a,b){g.ignoredVerbs[b]=a.toLowerCase()})),g.serviceUrl=d,g.batchEndpointUrl=e,a.push(g)},this.getBatchConfig=function(b){var c,d;for(d=0;d<a.length&&(c=a[d],!(b.indexOf(c.serviceUrl)>-1));d+=1)c=void 0;return c},this.canBatchCall=function(a,b){var c=this.getBatchConfig(a),d=c?c.canBatchRequest:void 0,e=!1;return c&&c.enabled===!0&&(e=d?d(a,b):c.batchEndpointUrl!==a&&-1===c.ignoredVerbs.indexOf(b.toLowerCase())),e},this.calculateBoundary=function(){return(new Date).getTime().toString()},this.$get=[function(){return this}]}]),b.module(a.ahb.name).factory("httpBatcher",["$injector","$document","$window","$timeout","httpBatchConfig",function(a,c,d,e,f){var g={httpVersion:"HTTP/1.1",newline:"\r\n",emptyString:"",singleSpace:" ",forwardSlash:"/",doubleDash:"--",colon:":"},h={},i=function(a,b,c){this.part=a,this.request=b,this.boundaryToken=c},j=function(a,c){var d=this;this.config=a,this.sendCallback=c,this.requests=[],this.currentTimeoutToken=e(function(){d.currentTimeoutToken=void 0,d.requests.length<d.config.minimumBatchSize?(d.sendCallback(),b.forEach(d.requests,function(a){a.continueDownNormalPipeline()})):d.send()},a.batchRequestCollectionDelay,!1)},k=function(a,b){return f.canBatchCall(a,b)},l=function(a){var b=f.getBatchConfig(a.url),c=h[b.batchEndpointUrl];void 0===c&&(c=new j(b,function(){delete h[b.batchEndpointUrl]}),h[b.batchEndpointUrl]=c),c.addRequest(a)},m=function(a){b.forEach(h,function(b,c){var d=void 0===a||a&&c.toLocaleLowerCase()===a.toLocaleLowerCase();d&&b.flush()})};return i.prototype=function(){var a=function(a,c){var d=c;return a=a.toLowerCase(),a.indexOf("json")>-1&&(d=b.fromJson(c)),d},c=function(a){return a=a.trim?a.trim():a.replace(/^\s+|\s+$/g,"")},d=function(a){var b,c="";for(b in a)c+=b+": "+a[b]+"\n";return c},e=function(){var b,e,f,h,i,j,k=this.part.split(g.newline),l={headers:{}},m=!1;for(e=0;e<k.length;e+=1)if(b=k[e],b!==g.emptyString){if(void 0===l.contentType&&-1!==b.indexOf("-Type")&&-1===b.indexOf("; msgtype=response"))l.contentType=b.split(g.forwardSlash)[1];else if(void 0!==l.contentType&&m===!1)j=b.split(g.colon),l.headers[j[0]]=c(j[1]);else if(void 0===l.statusCode&&-1!==b.indexOf(g.httpVersion))i=b.split(g.singleSpace),l.statusCode=parseInt(i[1],10),l.statusText=i.slice(2).join(g.singleSpace);else if(void 0===l.data&&m){for(l.data="",f=1,h=new RegExp("--"+this.boundaryToken+"--","i");h.test(b)===!1&&e+f<=k.length;)l.data+=b,b=k[e+f],f+=1;l.data=a(l.contentType,l.data);break}}else m=void 0!==l.contentType;l.headers["Content-Type"]=l.contentType,l.headerString=d(l.headers),this.request.callback(l.statusCode,l.data,l.headerString,l.statusText)};return{process:e}}(),j.prototype=function(){var h=function(a,b){var d,e,h,i,j=f.calculateBoundary(),k={method:"POST",url:b.batchEndpointUrl,cache:!1,headers:b.batchRequestHeaders||{}},l=[];for(k.headers["Content-Type"]="multipart/mixed; boundary="+j,e=0;e<a.length;e+=1){if(h=a[e],d=m(h.url),l.push(g.doubleDash+j),b.batchPartRequestHeaders)for(i in b.batchPartRequestHeaders)l.push(i+g.colon+g.singleSpace+b.batchPartRequestHeaders[i]);l.push("Content-Type: application/http; msgtype=request",g.emptyString),l.push(h.method+" "+d.relativeUrl+" "+g.httpVersion),l.push("Host: "+d.host);for(i in h.headers)l.push(i+g.colon+g.singleSpace+h.headers[i]);b.sendCookies===!0&&c[0].cookie&&c[0].cookie.length>0&&l.push("Cookie: "+c[0].cookie),l.push(g.emptyString),h.data&&l.push(h.data),l.push(g.emptyString)}return l.push(g.doubleDash+j+g.doubleDash),k.data=l.join(g.newline),k},j=function(){var c=this;this.sendCallback(),a.get("$http")(h(this.requests,this.config)).then(function(a){var b,d,e,f=n(a.headers()["content-type"]),h=a.data.split(g.doubleDash+f+g.newline),j=0;for(b=0;b<h.length;b+=1)d=h[b],d!==g.emptyString&&(e=new i(d,c.requests[j],f),e.process(),j+=1)},function(a){b.forEach(c.requests,function(b){b.callback(a.statusCode,a.data,a.headers,a.statusText)})})},k=function(a){return this.requests.push(a),this.requests.length>=this.config.maxBatchedRequestPerCall&&this.flush(),!0},l=function(){e.cancel(this.currentTimeoutToken),this.currentTimeoutToken=void 0,this.send()},m=function(a){var b,c,e,f,h;return a.indexOf("://")>-1?(f=a.indexOf("://")+3,h=a.slice(f).split(g.forwardSlash),b=a.substring(0,f),c=h[0],e=function(){return delete h[0],h.join(g.forwardSlash)}()):(e=a,b=d.location.protocol,c=d.location.host),{protocol:b,host:c,relativeUrl:e}},n=function(a){var b="boundary=",c=a.indexOf(b),d=a.substring(c+b.length);return d=d.replace(/"/g,g.emptyString)};return{addRequest:k,send:j,flush:l}}(),{canBatchRequest:k,batchRequest:l,flush:m}}]),b.module(a.ahb.name).config(["$provide",function(a){a.decorator("$httpBackend",["$delegate","httpBatcher",function(a,c){var d=function(b,d,e,f,g,h,i,j){var k=this,l=arguments;return c.canBatchRequest(d,b)?void c.batchRequest({method:b,url:d,data:e,callback:f,headers:g,timeout:h,withCredentials:i,responseType:j,continueDownNormalPipeline:function(){a.apply(k,l)}}):a.apply(this,arguments)};return b.mock&&b.forEach(a,function(a,b){d[b]=a}),d}])}])}(window,angular);